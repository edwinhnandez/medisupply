services:
  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq-broker
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=mediplus
      - RABBITMQ_DEFAULT_PASS=mediplus123
      - RABBITMQ_DEFAULT_VHOST=/
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./scripts/init-rabbitmq.sh:/docker-entrypoint-initdb.d/init-rabbitmq.sh:ro
    networks:
      - mediplus-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # RabbitMQ Initialization Service
  rabbitmq-init:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq-init
    depends_on:
      - rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=mediplus
      - RABBITMQ_DEFAULT_PASS=mediplus123
    volumes:
      - ./scripts/init-rabbitmq.sh:/init-rabbitmq.sh:ro
    command: ["/bin/sh", "/init-rabbitmq.sh"]
    networks:
      - mediplus-network

  # DynamoDB Local para desarrollo
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    ports:
      - "8000:8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory"]
    environment:
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - AWS_DEFAULT_REGION=us-east-1
    networks:
      - mediplus-network

  # Supplier Service
  supplier-service:
    build:
      context: .
      dockerfile: supplier-service/Dockerfile
    container_name: supplier-service
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - RABBITMQ_URL=amqp://mediplus:mediplus123@rabbitmq:5672/
      - ENVIRONMENT=development
    depends_on:
      - rabbitmq
      - rabbitmq-init
      - dynamodb-local
    networks:
      - mediplus-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Purchase Order Service
  purchase-order-service:
    build:
      context: .
      dockerfile: purchase-order-service/Dockerfile
    container_name: purchase-order-service
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - RABBITMQ_URL=amqp://mediplus:mediplus123@rabbitmq:5672/
      - SUPPLIER_SERVICE_URL=http://supplier-service:8080
      - ENVIRONMENT=development
    depends_on:
      - rabbitmq
      - rabbitmq-init
      - dynamodb-local
      - supplier-service
    networks:
      - mediplus-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Script para crear tablas de DynamoDB
  create-tables:
    image: alpine:latest
    container_name: create-tables
    depends_on:
      - dynamodb-local
    environment:
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - AWS_DEFAULT_REGION=us-east-1
    command: |
      sh -c "
        apk add --no-cache aws-cli &&
        sleep 10 &&
        aws dynamodb create-table --table-name suppliers --attribute-definitions AttributeName=proveedor_id,AttributeType=S AttributeName=estado_proveedor,AttributeType=S --key-schema AttributeName=proveedor_id,KeyType=HASH --global-secondary-indexes IndexName=estado-index,KeySchema='[{AttributeName=estado_proveedor,KeyType=HASH}]',Projection='{ProjectionType=ALL}',ProvisionedThroughput='{ReadCapacityUnits=5,WriteCapacityUnits=5}' --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 --endpoint-url http://dynamodb-local:8000 || echo 'Table suppliers already exists' &&
        aws dynamodb create-table --table-name audit_traces --attribute-definitions AttributeName=traza_id,AttributeType=S AttributeName=proveedor_id,AttributeType=S AttributeName=fecha_cambio,AttributeType=S --key-schema AttributeName=traza_id,KeyType=HASH --global-secondary-indexes IndexName=proveedor-fecha-index,KeySchema='[{AttributeName=proveedor_id,KeyType=HASH},{AttributeName=fecha_cambio,KeyType=RANGE}]',Projection='{ProjectionType=ALL}',ProvisionedThroughput='{ReadCapacityUnits=5,WriteCapacityUnits=5}' --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 --endpoint-url http://dynamodb-local:8000 || echo 'Table audit_traces already exists' &&
        aws dynamodb create-table --table-name orders --attribute-definitions AttributeName=orden_id,AttributeType=S AttributeName=estado_orden,AttributeType=S AttributeName=proveedor_id,AttributeType=S AttributeName=fecha_generacion,AttributeType=S --key-schema AttributeName=orden_id,KeyType=HASH --global-secondary-indexes IndexName=estado-index,KeySchema='[{AttributeName=estado_orden,KeyType=HASH}]',Projection='{ProjectionType=ALL}',ProvisionedThroughput='{ReadCapacityUnits=5,WriteCapacityUnits=5}' IndexName=proveedor-fecha-index,KeySchema='[{AttributeName=proveedor_id,KeyType=HASH},{AttributeName=fecha_generacion,KeyType=RANGE}]',Projection='{ProjectionType=ALL}',ProvisionedThroughput='{ReadCapacityUnits=5,WriteCapacityUnits=5}' --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 --endpoint-url http://dynamodb-local:8000 || echo 'Table orders already exists' &&
        aws dynamodb create-table --table-name products --attribute-definitions AttributeName=producto_id,AttributeType=S AttributeName=stock_actual,AttributeType=N --key-schema AttributeName=producto_id,KeyType=HASH --global-secondary-indexes IndexName=stock-index,KeySchema='[{AttributeName=stock_actual,KeyType=HASH}]',Projection='{ProjectionType=ALL}',ProvisionedThroughput='{ReadCapacityUnits=5,WriteCapacityUnits=5}' --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 --endpoint-url http://dynamodb-local:8000 || echo 'Table products already exists' &&
        echo 'All tables created successfully'
      "
    networks:
      - mediplus-network

volumes:
  rabbitmq_data:

networks:
  mediplus-network:
    driver: bridge
